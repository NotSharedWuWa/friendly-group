<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Permanent Robot Tracker</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RobotTracker">
    <meta name="theme-color" content="#48bb78">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a202c, #2d3748);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        
        .status-active {
            background: linear-gradient(135deg, #2f855a, #48bb78);
            animation: pulse 2s infinite;
        }
        
        .location-data {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #48bb78;
            display: block;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .blink {
            animation: blink 2s infinite;
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
        
        /* Prevent zoom on double-tap */
        :focus {
            outline: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ PERMANENT TRACKER</h1>
            <p>Robot Location Tracking System</p>
        </div>
        
        <div id="statusPanel" class="status-panel">
            <h2 id="statusText">üöÄ STARTING PERMANENT TRACKING...</h2>
            <p id="statusSubtext">Initializing GPS and connection...</p>
        </div>
        
        <div class="location-data">
            <h3>üìç LIVE LOCATION DATA</h3>
            <div class="data-row">
                <span>Latitude:</span>
                <span id="latValue">-</span>
            </div>
            <div class="data-row">
                <span>Longitude:</span>
                <span id="lonValue">-</span>
            </div>
            <div class="data-row">
                <span>Accuracy:</span>
                <span id="accValue">-</span>
            </div>
            <div class="data-row">
                <span>Last Update:</span>
                <span id="timeValue">-</span>
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <span class="stat-number" id="updateCount">0</span>
                    <span>Updates Sent</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="uptime">0m</span>
                    <span>Uptime</span>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <p>üîí <strong>PERMANENT TRACKING ACTIVE</strong></p>
            <p>‚Ä¢ Auto-starts on page load</p>
            <p>‚Ä¢ Works in background</p>
            <p>‚Ä¢ Survives screen lock</p>
            <p>‚Ä¢ Sends location every 10 seconds</p>
            <p>‚Ä¢ Add to Home Screen for best results</p>
        </div>
    </div>

    <script>
        // Configuration
        const FIREBASE_URL = "https://robottracker-85a47-default-rtdb.asia-southeast1.firebasedatabase.app/robot_location.json";
        
        // Tracking state
        let updateCount = 0;
        let isTracking = false;
        let startTime = Date.now();
        let trackingInterval;
        let watchId;
        let wakeLock = null;
        
        // DOM elements
        const statusPanel = document.getElementById('statusPanel');
        const statusText = document.getElementById('statusText');
        const statusSubtext = document.getElementById('statusSubtext');
        const latValue = document.getElementById('latValue');
        const lonValue = document.getElementById('lonValue');
        const accValue = document.getElementById('accValue');
        const timeValue = document.getElementById('timeValue');
        const updateCountEl = document.getElementById('updateCount');
        const uptimeEl = document.getElementById('uptime');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('üïí INITIALIZING SYSTEM...', 'Checking permissions...');
            setTimeout(startPermanentTracking, 1000);
            startUptimeCounter();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Prevent context menu
            document.addEventListener('contextmenu', (e) => e.preventDefault());
            
            // Handle visibility changes
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Handle page becoming active again
            document.addEventListener('resume', attemptRestartTracking);
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOfflineStatus);
        }
        
        function handleVisibilityChange() {
            if (document.hidden) {
                updateStatus('üì± BACKGROUND TRACKING', 'Continuing in background...');
            } else {
                updateStatus('üì± ACTIVE TRACKING', 'Page is visible');
            }
        }
        
        function handleOnlineStatus() {
            updateStatus('‚úÖ BACK ONLINE', 'Resuming tracking...');
            if (!isTracking) {
                attemptRestartTracking();
            }
        }
        
        function handleOfflineStatus() {
            updateStatus('‚ùå OFFLINE', 'No internet connection');
        }
        
        function updateStatus(mainText, subText) {
            statusText.textContent = mainText;
            statusSubtext.textContent = subText;
            
            if (mainText.includes('‚úÖ') || mainText.includes('ACTIVE')) {
                statusPanel.className = 'status-panel status-active';
            } else if (mainText.includes('‚ùå')) {
                statusPanel.className = 'status-panel';
            }
        }
        
        function updateDisplay(lat, lon, accuracy, timestamp) {
            latValue.textContent = lat.toFixed(6);
            lonValue.textContent = lon.toFixed(6);
            accValue.textContent = accuracy ? `${accuracy.toFixed(1)}m` : 'Unknown';
            timeValue.textContent = timestamp;
            updateCountEl.textContent = ++updateCount;
        }
        
        function updateUptime() {
            const minutes = Math.floor((Date.now() - startTime) / 60000);
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            
            if (hours > 0) {
                uptimeEl.textContent = `${hours}h ${remainingMinutes}m`;
            } else {
                uptimeEl.textContent = `${minutes}m`;
            }
        }
        
        function startUptimeCounter() {
            setInterval(updateUptime, 60000); // Update every minute
        }
        
        async function acquireWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock acquired');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released');
                    });
                }
            } catch (err) {
                console.warn('Wake Lock not supported or failed:', err);
            }
        }
        
        function sendLocation(latitude, longitude, accuracy) {
            const timestamp = new Date().toLocaleTimeString();
            
            const locationData = {
                latitude: latitude,
                longitude: longitude,
                accuracy: accuracy,
                timestamp: timestamp,
                updateCount: updateCount + 1,
                uptime: Math.floor((Date.now() - startTime) / 1000),
                device: 'robot_permanent_tracker'
            };
            
            // Send to Firebase
            fetch(FIREBASE_URL, {
                method: 'PUT',
                body: JSON.stringify(locationData),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                updateDisplay(latitude, longitude, accuracy, timestamp);
                updateStatus('‚úÖ TRACKING ACTIVE', `Last update: ${timestamp}`);
            })
            .catch(error => {
                console.error('Send error:', error);
                updateStatus('‚ö†Ô∏è SEND FAILED', 'Retrying...');
            });
        }
        
        function startPermanentTracking() {
            if (isTracking) return;
            
            if (!navigator.geolocation) {
                updateStatus('‚ùå GEOLOCATION ERROR', 'GPS not supported on this device');
                return;
            }
            
            updateStatus('üõ∞Ô∏è ACQUIRING GPS...', 'Requesting location permissions...');
            
            // Request high accuracy location
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    onLocationSuccess(position);
                    startContinuousTracking();
                },
                function(error) {
                    onLocationError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }
        
        function onLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            isTracking = true;
            acquireWakeLock();
            
            sendLocation(lat, lon, accuracy);
            updateStatus('üéØ PERMANENT TRACKING ACTIVE', 'GPS acquired - sending every 10 seconds');
            
            console.log('Permanent tracking started successfully');
        }
        
        function onLocationError(error) {
            let errorMessage = 'Unknown error';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Location permission denied. Please allow location access in browser settings.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Location unavailable. Check GPS signal.';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'Location request timeout. Retrying...';
                    break;
            }
            
            updateStatus('‚ùå LOCATION ERROR', errorMessage);
            console.error('Geolocation error:', error);
            
            // Auto-retry after 30 seconds
            setTimeout(attemptRestartTracking, 30000);
        }
        
        function startContinuousTracking() {
            // Regular interval updates
            trackingInterval = setInterval(() => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        sendLocation(lat, lon, accuracy);
                    },
                    (error) => {
                        console.warn('Interval location error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 5000
                    }
                );
            }, 10000); // Send every 10 seconds
            
            // Watch for significant position changes
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    // Optional: Could send on significant movement
                    // Currently just using for better accuracy
                },
                (error) => {
                    console.warn('Watch position error:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 15000
                }
            );
        }
        
        function attemptRestartTracking() {
            if (!isTracking) {
                console.log('Attempting to restart tracking...');
                updateStatus('üîÑ RESTARTING TRACKING', 'Attempting to reconnect...');
                startPermanentTracking();
            }
        }
        
        function stopTracking() {
            isTracking = false;
            
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            if (wakeLock) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                });
            }
            
            updateStatus('üõë TRACKING STOPPED', 'Location updates paused');
        }
        
        // Auto-restart if tracking stops unexpectedly
        setInterval(() => {
            if (!isTracking) {
                attemptRestartTracking();
            }
        }, 60000); // Check every minute
        
        // Handle page unload
        window.addEventListener('beforeunload', (e) => {
            if (isTracking) {
                e.preventDefault();
                e.returnValue = 'Permanent tracking is active. Are you sure you want to leave?';
            }
        });
        
        // Export functions for debugging
        window.tracker = {
            start: startPermanentTracking,
            stop: stopTracking,
            status: () => ({ isTracking, updateCount })
        };
        
    </script>
</body>
</html>
